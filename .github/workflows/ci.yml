name: CI

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 3

jobs:
  lint:
    name: Lint & type-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          # Use the CI environment (CPU-only JAX)
          environments: ci
          enable-cache: true
      - name: Run pre-commit (via pixi)
        run: pixi run -e dev pre-commit run --all-files
      - name: Run ruff (via pre-commit)
        if: always()
        run: pixi run -e dev pre-commit run ruff-check --all-files
      - name: Run mypy (via pre-commit)
        if: always()
        run: pixi run -e dev pre-commit run mypy --all-files
      - name: Run pylint (via pixi)
        if: always()
        run: pixi run -e dev pylint

  tests:
    name: Tests (CPU JAX)
    runs-on: ${{ matrix.os }}
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          environments: ci
          enable-cache: true
      - name: Run tests (pytest)
        run: pixi run -e ci test
      - name: Upload coverage report
        if: always()
        uses: codecov/codecov-action@v5
        with:
          # If the repo is public, token is not required. Provide if available.
          token: ${{ secrets.CODECOV_TOKEN }}
